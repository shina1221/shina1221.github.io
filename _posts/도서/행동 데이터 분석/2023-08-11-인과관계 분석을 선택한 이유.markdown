---
layout: post
title: 회귀분석을 방해하는 교란
date: 2023-08-02 19:20:23 +0900
category: DA
use_math: true
---
# 행동 데이터 분석  
> 회귀 분석을 방해하는 교란   

예측분석에서는 회귀를 알 수 없는(주로 미래의)값을 추정할 때 사용한다.  
이미 알고 있는 정보를 수집하고 다양한 요소를 종합해 가장 적합한 값을 추측한다.  
이 때 예측한 이유나 방법이 아닌 예측한 값과 정확도가 가장 중요하다.  
  
인과관계 분석에서는 목표변수의 값을 추측하는 것말고도 특정값을 유도한 요인이 무엇인가에 초점을 맞춰  
독립변수와의 관계를 중요하게 본다.    
잘 설계된 회귀분석에서 상관계수는 종속변수에 대한 독립변수의 인과 효과를 잘 나타내는 좋은 지표가 될 수 있다.  
       
예측 분석에서 사용하는 회귀분석을 그대로 사용하면서 주어진 계수로 인과관계를 측정할 수는 없다.  
회귀 분석에서 각 변수는 다른 변수에 영향을 줄 수 있기 때문이다.  
따라서 인과관계 분석에서는 변수를 정확한 예측을 목표로 설정하기 보다 정확한 관계의 계수를 가질 수 있도록  
설계해야 한다.

예제1)  
chap1-stand_data.csv: 판매한 아이스 크림과 아이스 커피의 일일 매출 데이터  
chap1-sruvey_data.csv: 매장 밖에 행인을 대상으로 한 설문 조사 
  
A 기업은 날씨가 일일 매출에 영향을 미친다고 생각하고 있다.  
인과용어로 날씨가 매출의 인과요인이라고 판단하는 것이다. 이는 다른 모든 조건이 동일할 때 기온이 높아질수록  
사람들이 아이스크림을 구매할 확률이 증가한다는 것이다.  

! 실제 EDA를 수행해본 결과 git 데이터가 책과 내용이 많이 다르므로 책 내용으로 진행  
  
절편추정치를 제공하는 coefficients(계수)영역을 보면  
temps의 estimate는 1145.320으로 기온이 1도 오를때마다 아이스크림 매출이 1145씩 늘어난다고 볼 수 있다.  
  
이후 10월에 A기업에서 모델의 예측에 따라 가판대의 아이스크림의 재고를 미리 늘렸다고 가정했을 때  
해당 주의 주간 매출은 평소보다 높긴 했지만 모델에서 예측한 값에 미치지 못했다.  
모델이 예측에 실패한 이유는 예측에 결정적인 영향을 미치는 요인을 고려하지 않았기 때문이다. 
대부분의 아이스크림 매출은 학생들이 학교를 가지 않는 여름방학 기간에 발생한다.  
회귀모델은 주어진 데이터를 활용해 최선의 예측을 수행했지만 여름방학의 기간이 기온과 양의 상관관계가 있기 때문에 아이스크림 매출 증가에 영향을 주는 여름방학의 효과를 기온에 의한 것처럼 해석하는 오류가 있었다.  
10월에 기온이 올라가지만 학생들의 여름방학이 생기는 것은 아니므로 같은 기간의 여름방학 기간보다 매출이 낮은 것이었다.  
  
기술적인 용어로 보면 1년 중 판매 시점이 기온과 매출의 관계를 교란하는 요인이다.  
**이것을 교란변수라고 하며 회귀모델에 편향을 조성하는 변수를 의미한다.**  
교란변수가 있는 환경에서 회귀모델의 계수를 인과관계로 해석하면 잘못된 결론을 내리게 된다.  
  
겨울은 춥고 여름은 매우 더운 대륙성 기후를 보이는 지역에서 매출이 발생한 월을 고려하지 않고 무작위로 더운 날과  
추운날의 아이스크림 매출을 비교한다면 더운 날은 학생들이 학교에 가지않는 여름방학 기간에 추운 날은 학생들이  
학교에 가는 겨울에 속할 가능성이 높다. 이렇게 되면 기온과 매출의 관계를 과대평가하게 될 것이다.  
  
또한 여름방학기간이 아이스크림 구매 행동에 큰 변화를 주지만 회귀 모델에서 오직 기온이라는 변수만으로 이 행동의  
변화를 표현한다면 그 계수는 더운 날씨에 대해 과도하게 크고 추운 날씨에 대해선 과도하게 작을 것이다.  
  
> 사공이 많으면 배가 산으로 간다.  

변수가 너무 많으면 문제가 될 수 있다. 교란 현상을 해결하는 잠재적인 방법은 회귀 모델에 가능한 모든 변수를 포함하는 것이다. 2018년 주데아 펄과 맥켄지에 의하면 관찰된 공변량(covariance)을 조건화하기를 피하는 것은  
비과학적인 임기응변이라고 저술했다. 많은 데이터 과학자들이 이 사고방식에 동의하는데  
  
**어떤 변수의 값을 예측하는 것만이 목적이라면 그저 테스트 데이터를 적절히 일반화하는 모델을 만들고 예측된 변수가**  
**특정 값을 갖는 이유는 궁금해하지 않아도 된다. 하지만 인과관계를 이해하고 이를 기반으로 어떤 의사결정을 내리는**   
**것이 목적이라면 이런 사고방식은 통하지 않는다.** 이 경우에는 분석 모델에 가능한 한 모든 변수를 포함하는 것이  
비효율적일 뿐만 아니라 역효과를 일으키고 결과를 왜곡할 수 있다.  
  
위의 예시에서 아이스크림 매출은 기온과 상관관계를 갖지만 여름철 여부변수(7월이나 8월이면1 아니면 0)와 관계가  없다. 여기에 아이스 커피 매출 변수를 추가한 뒤 OLS를 수행하면 기온변수의 coef는 -1651로 바뀐다.  
또한 기온변수와 아이스커피 변수의 p_value가 0.05보다 높은 값을 보이는 결과가 나온다.  
여기서 기온변수의 p_value가 0.408, 아이스 커피판매 변수가 0.184로 나와 기온변수를 모델에서 제거해야 한다는  
결론을 내릴 수도 있다.  
  
사람들은 날씨가 더울수록 아이스 커피를 많이 산다.    
그러나 아이스커피를 구매하는 행위가 아이스크림 구매의 행위에 영향을 주는 것은 아니다.
여름방학을 맞은 학생들은 아이스커피의 주요 구매층이 아니기 때문에 여름이라는 시간 요소는 아이스 커피 구매와  
상관관계가 없다.  
  
> 자세히 보기  
$\varepsilon$는 베셉실론이다.  
  
예제 데이터의 아이스크림 매출은 다음의 공식을 따른다.  
$icecreamsales:= 1000.Temp + 20000.summerMonth +\varepsilon _{1} $  
  
**이때 $\varepsilon _{i}$은 평균이 0인 임의의 노이즈를 나타낸다.**  
$:=$는 우변이 좌변의 변수 icecreamsales를 정의한다는 것을 의미한다.  
  
하지만 선형회귀에서 추정한 방정식은 다음과 같다.  
$icecreamsales=\beta_{t}.temp+\beta_{s}.summerMonth+\beta_{c}.icedcoffeesales$  
  
아이스크림 커피 매출이 따르는 공식은 다음과 같다.  
$icecreamsales:=1000.temp + \varepsilon _{2}$
  
$icecreamsales=\beta_{t}.temp+\beta_{s}.summerMonth+\beta_{c}(1000.temp+\varepsilon_{2})$  
$=(\beta_t +1000\beta_c).Tmep +\beta_s.summermonth$  
  
특별한 일이 없다면 계수 $\beta_{s}$는 실제 값 20000에 가깝게 도출될 것이다.  
하지만 temp의 경우 회귀모델은 다음의 방정식을 적용한다.  
$\beta_{t}+1000.\beta{c}=1000$  
다음의 방정식이 나오는 이유는 매출 공식에 $1000.temp$라고 되어있기 때문이다.  
  
**이 방정식에는 2개의 미지수가 있기 때문에 무한한 해를 갖는다.**  
$\beta_{t}=0$과 $\beta_{t}=1, \beta_{t}=500$과 $\beta_{c}=0.5$ 등이 모두 해가 될 수 있다.
아무수나 넣어서 1000을 만들면 되기 때문이다.  
**최소제곱법은 가장 큰 R_Squared 값을 유도하는 해를 선택하겠지만 이 값을 신뢰할 수는 없다.**
**(현실 세계 문제에서는 보통 더 쓸만하다.) 이런식으로 다중공선성이 생기는 점을 유의해야한다.**  
    
기온이 올라가면 아이스커피와 아이스크림의 매출이 모두 오르기 때문에 두 변수 사이에 양의 상관관계가 있다는 점을  
보여준다. 여름철 아이스 커피의 매출이 증가하는 것은 기온 변수와 아이스 커피 매출이 갖는 양의 상관관계를 기반으로  
설명할 수 있다.  
  
회귀 알고리즘이 기온, 여름철 여부, 아이스커피 매출이라는 세가지 변수를 사용해 아이스크림 매출을 예측한다면  
아이스 커피 매출에 미치는 기온의 영향력이 기온 변수에 반영되고 아이스 커피 매출은 기온이 갖는 과도한 영향력을  
줄이도록 모델링된다.  
아이스커피 매출은 통계적으로 유의하지 않고 계수가 상대적으로 작지만 달러 단위의 매출이 온도 단위의 기온보다  
절대수치가 훨씬 크다는 점에서 기온의 계수가 과장된 것을 상쇄한다.  
사견)상쇄한다는 것은 $\beta_{t}+1000.\beta{c}=1000$에서 1000으로 상쇄한다는 것을 의미하는 듯하다.     
  
예제에 변수 icedcoffeesales를 회귀 분석에 추가하면서 기온과 아이스크림 매출 사이의 관계가 혼란스러워졌다.  
이는 기온과 아이스커피 매출의 관계까지 좋지 않은 영향을 받을 수 있다.  
**회귀에 잘못된 변수를 추가하면 실제로 존재하지 않는 환상속의 관계를 만들수도 있다.**  
  
예제2)  
A기업 밖을 지나다니는 행인에게 바닐라 아이스크림과 초콜릿 아이스크림을 얼마나 좋아하는지 (0에서 25점 사이)  
그리고 아이스크림을 가판대에서 구매한 경험이 있는지 물어보았다.  
사람들은 두가지 맛을 모두 좋아하거나 한가지 맛을 조금 더 선호할 수도 있다.  
이 선호도는 한 사람이 아이스크림을 구매하는지 여부(예, 아니오)를 나타내는 이진형 변수 shopped에 영향을 미친다.  
  
shopped 변수는 이항변수이므로 맛의 선호도를 나타내는 2개의 taste 변수가 구매행위에 미치는 영향을  
측정할 때 로지스틱 회귀를 사용한다. 두 taste 변수는 상관관계가 없기 때문에 이 두 변수를 플롯차트로 나타내면  
상관관계를 확인할 수 없는 둥그런 구름이 그려진다. 하지만 각 taste 변수는 구매 가능성에 영향을 미친다.  
  
![이미지1](./img/01.JPG)  
1. 전체 모집단에서 바닐라와 초콜릿 맛의 선호도는 상관관계가 없다.  
2. 아이스크림을 구매하지 않은 사람보다 구매한 사람이 바닐라 맛을 더 선호한다.  
3. 아이스크림을 구매하지 않은 사람보다 구매한 사람이 초콜릿 맛을 더 선호한다.    
  
첫번째 그래프에서 회귀선이 완벽한 수평을 이룬다는 사실은 두 변수가 상관관계가 없다는 것이다.  
이때 상관계수는 표본오차를 반영해 0.004이다. 두번째와 세번째 그래프에서 바닐라와 초콜릿 맛의 선호도는  
아이스크림을 구매하지 않은 사람보다 구매한 고객(shopped가 1인)가 더 높게 나왔다.  
가판대에서 바닐라와 초콜릿 맛 아이스크림을 팔고 있어서 구매한 고객이 높은 선호도를 갖는것은 자연스러운  
결과라고 해석할 수 있다.    
  
A기업에서 설문조사 데이터를 바탕으로 가판대에서 아이스크림을 구매하면 다음에 구매할 때 사용할 수 있는 할인 쿠폰을  
주는 것을 검토하고 있다고 가정해본다.  
이 쿠폰은 가판대에서 아이스크림을 구매한 적이 없는 사람에게 영향을 미치지 않으므로 쿠폰을 지급할 모집단은 구매자다.  
해당 기업에서는 아이스크림 재고를 관리할 수 있도록 쿠폰으로 구매할 수 있는 맛을 제한하고 싶어하지만  
이것이 각 맛의 구매량에 어떤 영향을 줄 수 있을지는 모른다. 바닐라 맛을 구매한 사람에게 초콜릿 맛을 50% 할인하는  
쿠폰을 준다면 좋아할지 의문이다.  
  
가판대에서 아이스크림을 구매한 사람만 고려해 선호도를 본 경우  
![이미지2](./img/02.JPG)  
상관계수는 -0.39로 두 변수 사이에 강한 음의 상관관계가 있다는 점을 알 수 있다.  
  
앞서 봤던 그래프에서 인과관계를 보면 바닐라맛 선호도가 높을 수록 아이스크림 구매로 이어지는 경향이 있었고,  
초콜릿 맛도 마찬가지였다. 이는 두 변수에 **누적 효과**가 있다는 의미다.  
바닐라 아이스크림과 초콜릿 아이스크림을 둘 다 좋아하지 않는 사람은 아이스크림을 구매할 가능성이 매우 낮다.  
다시 말하면 **아이스크림을 구매했다면 적어도 두가지 맛 중에 하나는 좋아하는 경향이 있다는 것으로**  
**바닐라 아이스크림을 좋아하지 않는 사람은 초콜릿 맛을 좋아하지 않아도 아이스크림을 구매했을 것이다.**  
그래프를 확인했을 때 바닐라 맛의 선호도가 대략 15점보다 높은 경우에 초콜릿맛의 선호도가 15점 이하로 낮은 경우가  
있었다. 반면 바닐라맛의 선호도가 5점 이하로 낮은 경우는 초콜릿 맛의 선호도가 17점 이상으로 높았다.  
정리하면 **이 음의 상관관계는 구매전후에 입맛이 바뀌었기 때문이 아닌 바닐라와 초콜릿 맛을 모두 좋아하지**  
**않는 사람을 분석 대상에서 제외했기 때문에 관찰되는 일종의 허위 관계이다.**      
  
**벅슨의 역설(Berkson's Paradox)**  
해명효과(explain away effect)라고도 부르는데 어떤 구매 고객이 바닐라 맛을 매우 좋아한다면  
초콜릿 맛의 선호도와는 상관없이 아이스크림을 구매한 이유를 충분히 설명할 수 있다.  
반면 어떤 구매고객이 바닐라 맛을 선호하지 않는다면 바닐라 아이스크림을 구매할 이유가 없기 때문에  
초콜릿 아이스크림을 구매했을 것이고 초콜릿 맛의 선호도가 매우 높을 것이다.  
  
데이터에 편향이 있을 때 인위적인 상관관계가 생기는 현상을 설명하는 고전적인 예를 들면  
일반적인 모집단이 아니라 병원 환자를 모집단으로 설정하면 몇몇 질병이 더 강한 상관관계를 보인다.  
한가지 병에 걸렸을 때보다 두가지 병을 함께 앓을 때 건강이 더 악화될 것이고  
건강이 나쁠 수록 병원에 입원할 가능성이 높아져 병원 환자 모집단에 두가지 질병을 함께 앓는 경우가 많을 것이다.  
*해당 예시는 2개의 선형(또는 로지스틱)관계 대신 문턱효과가 있어 벅슨의 역설과는 약간 다른 상황이지만  
잘못된 변수를 분석에 포함하면 인위적인 상관관계가 생길 수 있다는 원리이다.  
  
> 정리하기  

선형 또는 로지스틱 회귀 분석을 할 때 변수를 무분별하게 추가해선 안된다.  
그레디언트 부스팅이나 딥러닝 모델은 교란변수, 다중공선성과 허위 상관관계로부터 자유롭지 않다.  
모델이 이런 현상에 영향을 받지 않는다고 느낀다면 이는 블랙박스라는 특성이 교란 현상을 발견하기 어렵게 만들기 때문이다.  

*심슨의 역설   
각 부분에 대한 평균이 크다고 해서 전체에 대한 평균까지 크지는 않다.  
공학부 합격자 비율이 여학생 합격률이 남학생 합격률보다 높다.  
식품영양학과 합격자 비율에 여학생 합격률이 남학생 합격률보다 높다.  
전체적으로 봤을 때 남학생 합격률이 여학생 합격률보다 높지만  
실질적으로 전체합격률을 봤을 때 남학생 합격률이 더 높을 수 있다.  
이는 각 부분의 샘플 크기나 비율이 다른데도 가중치를 주지 않았기 때문일 수 있다.(남녀의 성비 고려x)  
즉 하위 그룹의 클래스 불균형으로 인해 초래되는 현상으로 볼 수 있다.  
  
참고 출처:  
https://www.aitimes.com/news/articleView.html?idxno=47051  
https://ko.wikipedia.org/wiki/%EC%B0%A8%EC%9B%90%EC%9D%98_%EC%A0%80%EC%A3%BC  
https://oreil.ly/BehavioralDataAnalysis  
https://namu.wiki/w/%EC%8B%AC%EC%8A%A8%EC%9D%98%20%EC%97%AD%EC%84%A4  
https://hleecaster.com/statistical-paradoxes-in-data-science/  

